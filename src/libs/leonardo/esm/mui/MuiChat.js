import { Box } from '@mui/material';
import dayjs from 'dayjs';
import React from 'react';
import { MuiAudioInput } from './MuiAudioInput';
import { MuiFileInput } from './MuiFileInput';
import { MuiMessage } from './MuiMessage';
import { MuiMultiSelectInput } from './MuiMultiSelectInput';
import { MuiSelectInput } from './MuiSelectInput';
import { MuiTextInput } from './MuiTextInput';
export function MuiChat({
  chatController
}) {
  const chatCtl = chatController;
  const [messages, setMessages] = React.useState(chatCtl.getMessages());
  const [actReq, setActReq] = React.useState(chatCtl.getActionRequest());
  const msgRef = React.useRef(null);
  const scroll = React.useCallback(() => {
    if (msgRef.current) {
      msgRef.current.scrollTop = msgRef.current.scrollHeight; // msgRef.current.scrollIntoView(true);
    }
  }, [msgRef]);
  React.useEffect(() => {
    function handleMassagesChanged() {
      setMessages([...chatCtl.getMessages()]);
      scroll();
    }

    function handleActionChanged() {
      setActReq(chatCtl.getActionRequest());
      scroll();
    }

    chatCtl.addOnMessagesChanged(handleMassagesChanged);
    chatCtl.addOnActionChanged(handleActionChanged);
  }, [chatCtl, scroll]);
  const CustomComponent = React.useMemo(() => {
    if (!actReq || actReq.type !== 'custom') {
      return null;
    }

    return actReq.Component;
  }, [actReq]);
  const unknownMsg = {
    type: 'text',
    content: 'Unknown message.',
    self: false
  };
  let prevDate = dayjs(0);
  let prevTime = dayjs(0);
  return /*#__PURE__*/React.createElement(Box, {
    sx: {
      height: '100%',
      width: '100%',
      p: 1,
      bgcolor: 'background.default',
      display: 'flex',
      flexDirection: 'column',
      '& > *': {
        maxWidth: '100%'
      },
      '& > * + *': {
        mt: 1
      }
    }
  }, /*#__PURE__*/React.createElement(Box, {
    sx: {
      flex: '1 1 0%',
      overflowY: 'auto',
      WebkitOverflowScrolling: 'touch',
      display: 'flex',
      flexDirection: 'column',
      '& > *': {
        maxWidth: '100%'
      }
    },
    ref: msgRef
  }, messages.map(msg => {
    let showDate = false;
    let showTime = !!chatCtl.getOption().showDateTime;

    if (!!chatCtl.getOption().showDateTime && !msg.deletedAt) {
      const current = dayjs(msg.updatedAt ? msg.updatedAt : msg.createdAt);

      if (current.format('YYYYMMDD') !== prevDate.format('YYYYMMDD')) {
        showDate = true;
      }

      prevDate = current;

      if (current.diff(prevTime) < 60000) {
        showTime = false;
      } else {
        prevTime = current;
      }
    }

    if (msg.type === 'text' || msg.type === 'jsx') {
      return /*#__PURE__*/React.createElement(MuiMessage, {
        key: messages.indexOf(msg),
        id: `cu-msg-${messages.indexOf(msg) + 1}`,
        message: msg,
        showDate: showDate,
        showTime: showTime
      });
    }

    return /*#__PURE__*/React.createElement(MuiMessage, {
      key: messages.indexOf(msg),
      id: `cu-msg-${messages.indexOf(msg) + 1}`,
      message: unknownMsg,
      showDate: showDate,
      showTime: showTime
    });
  })), /*#__PURE__*/React.createElement(Box, {
    sx: {
      flex: '0 1 auto',
      display: 'flex',
      alignContent: 'flex-end',
      '& > *': {
        minWidth: 0
      }
    }
  }, actReq && actReq.type === 'text' && /*#__PURE__*/React.createElement(MuiTextInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'select' && /*#__PURE__*/React.createElement(MuiSelectInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'multi-select' && /*#__PURE__*/React.createElement(MuiMultiSelectInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'file' && /*#__PURE__*/React.createElement(MuiFileInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'audio' && /*#__PURE__*/React.createElement(MuiAudioInput, {
    chatController: chatCtl,
    actionRequest: actReq
  }), actReq && actReq.type === 'custom' && /*#__PURE__*/React.createElement(CustomComponent, {
    chatController: chatCtl,
    actionRequest: actReq
  })));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tdWkvTXVpQ2hhdC50c3giXSwibmFtZXMiOlsiQm94IiwiZGF5anMiLCJSZWFjdCIsIk11aUF1ZGlvSW5wdXQiLCJNdWlGaWxlSW5wdXQiLCJNdWlNZXNzYWdlIiwiTXVpTXVsdGlTZWxlY3RJbnB1dCIsIk11aVNlbGVjdElucHV0IiwiTXVpVGV4dElucHV0IiwiTXVpQ2hhdCIsImNoYXRDb250cm9sbGVyIiwiY2hhdEN0bCIsIm1lc3NhZ2VzIiwic2V0TWVzc2FnZXMiLCJ1c2VTdGF0ZSIsImdldE1lc3NhZ2VzIiwiYWN0UmVxIiwic2V0QWN0UmVxIiwiZ2V0QWN0aW9uUmVxdWVzdCIsIm1zZ1JlZiIsInVzZVJlZiIsInNjcm9sbCIsInVzZUNhbGxiYWNrIiwiY3VycmVudCIsInNjcm9sbFRvcCIsInNjcm9sbEhlaWdodCIsInVzZUVmZmVjdCIsImhhbmRsZU1hc3NhZ2VzQ2hhbmdlZCIsImhhbmRsZUFjdGlvbkNoYW5nZWQiLCJhZGRPbk1lc3NhZ2VzQ2hhbmdlZCIsImFkZE9uQWN0aW9uQ2hhbmdlZCIsIkN1c3RvbUNvbXBvbmVudCIsInVzZU1lbW8iLCJ0eXBlIiwiQ29tcG9uZW50IiwidW5rbm93bk1zZyIsImNvbnRlbnQiLCJzZWxmIiwicHJldkRhdGUiLCJwcmV2VGltZSIsImhlaWdodCIsIndpZHRoIiwicCIsImJnY29sb3IiLCJkaXNwbGF5IiwiZmxleERpcmVjdGlvbiIsIm1heFdpZHRoIiwibXQiLCJmbGV4Iiwib3ZlcmZsb3dZIiwiV2Via2l0T3ZlcmZsb3dTY3JvbGxpbmciLCJtYXAiLCJtc2ciLCJzaG93RGF0ZSIsInNob3dUaW1lIiwiZ2V0T3B0aW9uIiwic2hvd0RhdGVUaW1lIiwiZGVsZXRlZEF0IiwidXBkYXRlZEF0IiwiY3JlYXRlZEF0IiwiZm9ybWF0IiwiZGlmZiIsImluZGV4T2YiLCJhbGlnbkNvbnRlbnQiLCJtaW5XaWR0aCJdLCJtYXBwaW5ncyI6IkFBQUEsU0FBU0EsR0FBVCxRQUFvQixlQUFwQjtB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LE1BQU0sSUFBSUEsTUFBTSxDQUFDaUIsSUFBUCxLQUFnQixRQUExQixpQkFDQyxvQkFBQyxjQUFEO0FBQ0UsSUFBQSxjQUFjLEVBQUV0QixPQURsQjtBQUVFLElBQUEsYUFBYSxFQUFFSztBQUZqQixJQWpCSixFQXNCR0EsTUFBTSxJQUFJQSxNQUFNLENBQUNpQixJQUFQLEtBQWdCLGNBQTFCLGlCQUNDLG9CQUFDLG1CQUFEO0FBQ0UsSUFBQSxjQUFjLEVBQUV0QixPQURsQjtBQUVFLElBQUEsYUFBYSxFQUFFSztBQUZqQixJQXZCSixFQTRCR0EsTUFBTSxJQUFJQSxNQUFNLENBQUNpQixJQUFQLEtBQWdCLE1BQTFCLGlCQUNDLG9CQUFDLFlBQUQ7QUFDRSxJQUFBLGNBQWMsRUFBRXRCLE9BRGxCO0FBRUUsSUFBQSxhQUFhLEVBQUVLO0FBRmpCLElBN0JKLEVBa0NHQSxNQUFNLElBQUlBLE1BQU0sQ0FBQ2lCLElBQVAsS0FBZ0IsT0FBMUIsaUJBQ0Msb0JBQUMsYUFBRDtBQUNFLElBQUEsY0FBYyxFQUFFdEIsT0FEbEI7QUFFRSxJQUFBLGFBQWEsRUFBRUs7QUFGakIsSUFuQ0osRUF3Q0dBLE1BQU0sSUFBSUEsTUFBTSxDQUFDaUIsSUFBUCxLQUFnQixRQUExQixpQkFDQyxvQkFBQyxlQUFEO0FBQ0UsSUFBQSxjQUFjLEVBQUV0QixPQURsQjtBQUVFLElBQUEsYUFBYSxFQUFFSztBQUZqQixJQXpDSixDQXRFRixDQURGO0FBd0hEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQm94IH0gZnJvbSAnQG11aS9tYXRlcmlhbCc7XG5pbXBvcnQgZGF5anMgZnJvbSAnZGF5anMnO1xuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcblxuaW1wb3J0IHsgQ2hhdENvbnRyb2xsZXIgfSBmcm9tICcuLi9jaGF0LWNvbnRyb2xsZXInO1xuaW1wb3J0IHtcbiAgQWN0aW9uUmVxdWVzdCxcbiAgQXVkaW9BY3Rpb25SZXF1ZXN0LFxuICBDdXN0b21BY3Rpb25SZXF1ZXN0LFxuICBGaWxlQWN0aW9uUmVxdWVzdCxcbiAgTXVsdGlTZWxlY3RBY3Rpb25SZXF1ZXN0LFxuICBTZWxlY3RBY3Rpb25SZXF1ZXN0LFxuICBUZXh0QWN0aW9uUmVxdWVzdCxcbn0gZnJvbSAnLi4vY2hhdC10eXBlcyc7XG5cbmltcG9ydCB7IE11aUF1ZGlvSW5wdXQgfSBmcm9tICcuL011aUF1ZGlvSW5wdXQnO1xuaW1wb3J0IHsgTXVpRmlsZUlucHV0IH0gZnJvbSAnLi9NdWlGaWxlSW5wdXQnO1xuaW1wb3J0IHsgTXVpTWVzc2FnZSB9IGZyb20gJy4vTXVpTWVzc2FnZSc7XG5pbXBvcnQgeyBNdWlNdWx0aVNlbGVjdElucHV0IH0gZnJvbSAnLi9NdWlNdWx0aVNlbGVjdElucHV0JztcbmltcG9ydCB7IE11aVNlbGVjdElucHV0IH0gZnJvbSAnLi9NdWlTZWxlY3RJbnB1dCc7XG5pbXBvcnQgeyBNdWlUZXh0SW5wdXQgfSBmcm9tICcuL011aVRleHRJbnB1dCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBNdWlDaGF0KHtcbiAgY2hhdENvbnRyb2xsZXIsXG59OiBSZWFjdC5Qcm9wc1dpdGhDaGlsZHJlbjx7XG4gIGNoYXRDb250cm9sbGVyOiBDaGF0Q29udHJvbGxlcjtcbn0+KTogUmVhY3QuUmVhY3RFbGVtZW50IHtcbiAgY29uc3QgY2hhdEN0bCA9IGNoYXRDb250cm9sbGVyO1xuICBjb25zdCBbbWVzc2FnZXMsIHNldE1lc3NhZ2VzXSA9IFJlYWN0LnVzZVN0YXRlKGNoYXRDdGwuZ2V0TWVzc2FnZXMoKSk7XG4gIGNvbnN0IFthY3RSZXEsIHNldEFjdFJlcV0gPSBSZWFjdC51c2VTdGF0ZShjaGF0Q3RsLmdldEFjdGlvblJlcXVlc3QoKSk7XG5cbiAgY29uc3QgbXNnUmVmID0gUmVhY3QudXNlUmVmPEhUTUxEaXZFbGVtZW50PihudWxsKTtcbiAgY29uc3Qgc2Nyb2xsID0gUmVhY3QudXNlQ2FsbGJhY2soKCk6IHZvaWQgPT4ge1xuICAgIGlmIChtc2dSZWYuY3VycmVudCkge1xuICAgICAgbXNnUmVmLmN1cnJlbnQuc2Nyb2xsVG9wID0gbXNnUmVmLmN1cnJlbnQuc2Nyb2xsSGVpZ2h0O1xuICAgICAgLy8gbXNnUmVmLmN1cnJlbnQuc2Nyb2xsSW50b1ZpZXcodHJ1ZSk7XG4gICAgfVxuICB9LCBbbXNnUmVmXSk7XG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgZnVuY3Rpb24gaGFuZGxlTWFzc2FnZXNDaGFuZ2VkKCk6IHZvaWQge1xuICAgICAgc2V0TWVzc2FnZXMoWy4uLmNoYXRDdGwuZ2V0TWVzc2FnZXMoKV0pO1xuICAgICAgc2Nyb2xsKCk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGhhbmRsZUFjdGlvbkNoYW5nZWQoKTogdm9pZCB7XG4gICAgICBzZXRBY3RSZXEoY2hhdEN0bC5nZXRBY3Rpb25SZXF1ZXN0KCkpO1xuICAgICAgc2Nyb2xsKCk7XG4gICAgfVxuICAgIGNoYXRDdGwuYWRkT25NZXNzYWdlc0NoYW5nZWQoaGFuZGxlTWFzc2FnZXNDaGFuZ2VkKTtcbiAgICBjaGF0Q3RsLmFkZE9uQWN0aW9uQ2hhbmdlZChoYW5kbGVBY3Rpb25DaGFuZ2VkKTtcbiAgfSwgW2NoYXRDdGwsIHNjcm9sbF0pO1xuXG4gIHR5cGUgQ3VzdG9tQ29tcG9uZW50VHlwZSA9IFJlYWN0LkZDPHtcbiAgICBjaGF0Q29udHJvbGxlcjogQ2hhdENvbnRyb2xsZXI7XG4gICAgYWN0aW9uUmVxdWVzdDogQWN0aW9uUmVxdWVzdDtcbiAgfT47XG4gIGNvbnN0IEN1c3RvbUNvbXBvbmVudCA9IFJlYWN0LnVzZU1lbW8oKCk6IEN1c3RvbUNvbXBvbmVudFR5cGUgPT4ge1xuICAgIGlmICghYWN0UmVxIHx8IGFjdFJlcS50eXBlICE9PSAnY3VzdG9tJykge1xuICAgICAgcmV0dXJuIG51bGwgYXMgdW5rbm93biBhcyBDdXN0b21Db21wb25lbnRUeXBlO1xuICAgIH1cbiAgICByZXR1cm4gKGFjdFJlcSBhcyBDdXN0b21BY3Rpb25SZXF1ZXN0KVxuICAgICAgLkNvbXBvbmVudCBhcyB1bmtub3duIGFzIEN1c3RvbUNvbXBvbmVudFR5cGU7XG4gIH0sIFthY3RSZXFdKTtcblxuICBjb25zdCB1bmtub3duTXNnID0ge1xuICAgIHR5cGU6ICd0ZXh0JyxcbiAgICBjb250ZW50OiAnVW5rbm93biBtZXNzYWdlLicsXG4gICAgc2VsZjogZmFsc2UsXG4gIH07XG5cbiAgbGV0IHByZXZEYXRlID0gZGF5anMoMCk7XG4gIGxldCBwcmV2VGltZSA9IGRheWpzKDApO1xuXG4gIHJldHVybiAoXG4gICAgPEJveFxuICAgICAgc3g9e3tcbiAgICAgICAgaGVpZ2h0OiAnMTAwJScsXG4gICAgICAgIHdpZHRoOiAnMTAwJScsXG4gICAgICAgIHA6IDEsXG4gICAgICAgIGJnY29sb3I6ICdiYWNrZ3JvdW5kLmRlZmF1bHQnLFxuICAgICAgICBkaXNwbGF5OiAnZmxleCcsXG4gICAgICAgIGZsZXhEaXJlY3Rpb246ICdjb2x1bW4nLFxuICAgICAgICAnJiA+IConOiB7XG4gICAgICAgICAgbWF4V2lkdGg6ICcxMDAlJyxcbiAgICAgICAgfSxcbiAgICAgICAgJyYgPiAqICsgKic6IHtcbiAgICAgICAgICBtdDogMSxcbiAgICAgICAgfSxcbiAgICAgIH19XG4gICAgPlxuICAgICAgPEJveFxuICAgICAgICBzeD17e1xuICAgICAgICAgIGZsZXg6ICcxIDEgMCUnLFxuICAgICAgICAgIG92ZXJmbG93WTogJ2F1dG8nLFxuICAgICAgICAgIFdlYmtpdE92ZXJmbG93U2Nyb2xsaW5nOiAndG91Y2gnLFxuICAgICAgICAgIGRpc3BsYXk6ICdmbGV4JyxcbiAgICAgICAgICBmbGV4RGlyZWN0aW9uOiAnY29sdW1uJyxcbiAgICAgICAgICAnJiA+IConOiB7XG4gICAgICAgICAgICBtYXhXaWR0aDogJzEwMCUnLFxuICAgICAgICAgIH0sXG4gICAgICAgIH19XG4gICAgICAgIHJlZj17bXNnUmVmfVxuICAgICAgPlxuICAgICAgICB7bWVzc2FnZXMubWFwKChtc2cpOiBSZWFjdC5SZWFjdEVsZW1lbnQgPT4ge1xuICAgICAgICAgIGxldCBzaG93RGF0ZSA9IGZhbHNlO1xuICAgICAgICAgIGxldCBzaG93VGltZSA9ICEhY2hhdEN0bC5nZXRPcHRpb24oKS5zaG93RGF0ZVRpbWU7XG4gICAgICAgICAgaWYgKCEhY2hhdEN0bC5nZXRPcHRpb24oKS5zaG93RGF0ZVRpbWUgJiYgIW1zZy5kZWxldGVkQXQpIHtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnQgPSBkYXlqcyhcbiAgICAgICAgICAgICAgbXNnLnVwZGF0ZWRBdCA/IG1zZy51cGRhdGVkQXQgOiBtc2cuY3JlYXRlZEF0LFxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaWYgKGN1cnJlbnQuZm9ybWF0KCdZWVlZTU1ERCcpICE9PSBwcmV2RGF0ZS5mb3JtYXQoJ1lZWVlNTUREJykpIHtcbiAgICAgICAgICAgICAgc2hvd0RhdGUgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcHJldkRhdGUgPSBjdXJyZW50O1xuXG4gICAgICAgICAgICBpZiAoY3VycmVudC5kaWZmKHByZXZUaW1lKSA8IDYwXzAwMCkge1xuICAgICAgICAgICAgICBzaG93VGltZSA9IGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcHJldlRpbWUgPSBjdXJyZW50O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAobXNnLnR5cGUgPT09ICd0ZXh0JyB8fCBtc2cudHlwZSA9PT0gJ2pzeCcpIHtcbiAgICAgICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICAgIDxNdWlNZXNzYWdlXG4gICAgICAgICAgICAgICAga2V5PXttZXNzYWdlcy5pbmRleE9mKG1zZyl9XG4gICAgICAgICAgICAgICAgaWQ9e2BjdS1tc2ctJHttZXNzYWdlcy5pbmRleE9mKG1zZykgKyAxfWB9XG4gICAgICAgICAgICAgICAgbWVzc2FnZT17bXNnfVxuICAgICAgICAgICAgICAgIHNob3dEYXRlPXtzaG93RGF0ZX1cbiAgICAgICAgICAgICAgICBzaG93VGltZT17c2hvd1RpbWV9XG4gICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgPE11aU1lc3NhZ2VcbiAgICAgICAgICAgICAga2V5PXttZXNzYWdlcy5pbmRleE9mKG1zZyl9XG4gICAgICAgICAgICAgIGlkPXtgY3UtbXNnLSR7bWVzc2FnZXMuaW5kZXhPZihtc2cpICsgMX1gfVxuICAgICAgICAgICAgICBtZXNzYWdlPXt1bmtub3duTXNnfVxuICAgICAgICAgICAgICBzaG93RGF0ZT17c2hvd0RhdGV9XG4gICAgICAgICAgICAgIHNob3dUaW1lPXtzaG93VGltZX1cbiAgICAgICAgICAgIC8+XG4gICAgICAgICAgKTtcbiAgICAgICAgfSl9XG4gICAgICA8L0JveD5cbiAgICAgIDxCb3hcbiAgICAgICAgc3g9e3tcbiAgICAgICAgICBmbGV4OiAnMCAxIGF1dG8nLFxuICAgICAgICAgIGRpc3BsYXk6ICdmbGV4JyxcbiAgICAgICAgICBhbGlnbkNvbnRlbnQ6ICdmbGV4LWVuZCcsXG4gICAgICAgICAgJyYgPiAqJzoge1xuICAgICAgICAgICAgbWluV2lkdGg6IDAsXG4gICAgICAgICAgfSxcbiAgICAgICAgfX1cbiAgICAgID5cbiAgICAgICAge2FjdFJlcSAmJiBhY3RSZXEudHlwZSA9PT0gJ3RleHQnICYmIChcbiAgICAgICAgICA8TXVpVGV4dElucHV0XG4gICAgICAgICAgICBjaGF0Q29udHJvbGxlcj17Y2hhdEN0bH1cbiAgICAgICAgICAgIGFjdGlvblJlcXVlc3Q9e2FjdFJlcSBhcyBUZXh0QWN0aW9uUmVxdWVzdH1cbiAgICAgICAgICAvPlxuICAgICAgICApfVxuICAgICAgICB7YWN0UmVxICYmIGFjdFJlcS50eXBlID09PSAnc2VsZWN0JyAmJiAoXG4gICAgICAgICAgPE11aVNlbGVjdElucHV0XG4gICAgICAgICAgICBjaGF0Q29udHJvbGxlcj17Y2hhdEN0bH1cbiAgICAgICAgICAgIGFjdGlvblJlcXVlc3Q9e2FjdFJlcSBhcyBTZWxlY3RBY3Rpb25SZXF1ZXN0fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICAgIHthY3RSZXEgJiYgYWN0UmVxLnR5cGUgPT09ICdtdWx0aS1zZWxlY3QnICYmIChcbiAgICAgICAgICA8TXVpTXVsdGlTZWxlY3RJbnB1dFxuICAgICAgICAgICAgY2hhdENvbnRyb2xsZXI9e2NoYXRDdGx9XG4gICAgICAgICAgICBhY3Rpb25SZXF1ZXN0PXthY3RSZXEgYXMgTXVsdGlTZWxlY3RBY3Rpb25SZXF1ZXN0fVxuICAgICAgICAgIC8+XG4gICAgICAgICl9XG4gICAgICAgIHthY3RSZXEgJiYgYWN0UmVxLnR5cGUgPT09ICdmaWxlJyAmJiAoXG4gICAgICAgICAgPE11aUZpbGVJbnB1dFxuICAgICAgICAgICAgY2hhdENvbnRyb2xsZXI9e2NoYXRDdGx9XG4gICAgICAgICAgICBhY3Rpb25SZXF1ZXN0PXthY3RSZXEgYXMgRmlsZUFjdGlvblJlcXVlc3R9XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgICAge2FjdFJlcSAmJiBhY3RSZXEudHlwZSA9PT0gJ2F1ZGlvJyAmJiAoXG4gICAgICAgICAgPE11aUF1ZGlvSW5wdXRcbiAgICAgICAgICAgIGNoYXRDb250cm9sbGVyPXtjaGF0Q3RsfVxuICAgICAgICAgICAgYWN0aW9uUmVxdWVzdD17YWN0UmVxIGFzIEF1ZGlvQWN0aW9uUmVxdWVzdH1cbiAgICAgICAgICAvPlxuICAgICAgICApfVxuICAgICAgICB7YWN0UmVxICYmIGFjdFJlcS50eXBlID09PSAnY3VzdG9tJyAmJiAoXG4gICAgICAgICAgPEN1c3RvbUNvbXBvbmVudFxuICAgICAgICAgICAgY2hhdENvbnRyb2xsZXI9e2NoYXRDdGx9XG4gICAgICAgICAgICBhY3Rpb25SZXF1ZXN0PXthY3RSZXEgYXMgQ3VzdG9tQWN0aW9uUmVxdWVzdH1cbiAgICAgICAgICAvPlxuICAgICAgICApfVxuICAgICAgPC9Cb3g+XG4gICAgPC9Cb3g+XG4gICk7XG59XG4iXX0=